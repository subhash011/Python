from helpers import *
import pandas as pd
import os
from collections import defaultdict as dd
import random
import pickle
import argparse
import sklearn
import numpy as np
import pandas as pd
import requests
import shutil
import json
import re
import statistics
import pickle
import time
from ast import literal_eval 
import sklearn
from sklearn.ensemble import RandomForestClassifier

features_path = "Features"
dynamic_features_path = os.path.join(features_path, "dynamic")
static_features_path = os.path.join(features_path, "static")
models_path = "models"
dynamic_train_benign_path = os.path.join(dynamic_features_path, "dynamic_train_benign.p")
dynamic_train_malware_path = os.path.join(dynamic_features_path, "dynamic_train_malware.p")
dynamic_test_data_path = os.path.join(dynamic_features_path, "dynamic_test_data.p")
dynamic_test_labels_path = os.path.join(dynamic_features_path, "dynamic_test_labels.p")
static_train_benign_path = os.path.join(static_features_path, "static_train_benign.p")
static_train_malware_path = os.path.join(static_features_path, "static_train_malware.p")
static_test_data_path = os.path.join(static_features_path, "static_test_data.p")
static_test_labels_path = os.path.join(static_features_path, "static_test_labels.p")
dynamic_model_path = os.path.join(models_path, "dynamic")
static_model_path = os.path.join(models_path, "static")

parser = argparse.ArgumentParser()
parser.add_argument('--nargs', nargs='+')
arguments = []

for _, value in parser.parse_args()._get_kwargs():
    if value is not None:
        arguments = value


train_index = -1
path_index = -1

if "train" in arguments:
    train_index = arguments.index("train")
    for x in arguments:
        if x != "train":
            path_index = arguments.index(x)
else:
    if len(arguments) != 0:
        path_index = 0


def classify_dynamic(file):
    try:
        file_features = get_features_of_file(dataset_path, file)
        data = pd.DataFrame([file_features])
        return dynamic_model.predict(data.values.reshape(1, -1))[0]
    except:
        return random.randint(0, 1)


def classify_static(folder):
    try:
        file_features = get_static_file_features(dataset_path, folder)
        data = pd.DataFrame([file_features])
        return static_model.predict(data.values.reshape(1, -1))[0]
    except:
        return random.randint(0, 1)


def write_csv(output):
    with open('output.csv', 'w') as f:
        for key in output.keys():
            f.write("%s,%s\n" % (key, output[key]))


def load_models():
    with open(static_model_path, "rb") as f:
        model_static = pickle.load(f)
    with open(dynamic_model_path, "rb") as f:
        model_dynamic = pickle.load(f)

    return model_static, model_dynamic

def train():
    with open(dynamic_train_malware_path, "rb") as f:
        dynamic_malware_train_data = pickle.load(f)
    with open(dynamic_train_benign_path, "rb") as f:
        dynamic_benign_train_data = pickle.load(f)

    dynamic_malware_train_data = pd.DataFrame(dynamic_malware_train_data)
    dynamic_benign_train_data = pd.DataFrame(dynamic_benign_train_data)
    dynamic_train_labels = np.array([1]*len(dynamic_malware_train_data) + [0]*len(dynamic_benign_train_data))
    dynamic_train_data = pd.concat([dynamic_malware_train_data, dynamic_benign_train_data])

    clf_dynamic = RandomForestClassifier(n_estimators=40)
    clf_dynamic.fit(dynamic_train_data, dynamic_train_labels)
    with open(dynamic_model_path, "wb") as f:
        pickle.dump(clf_dynamic,f,protocol=pickle.HIGHEST_PROTOCOL)

    with open(dynamic_test_data_path, "rb") as f:
        dynamic_test_data = pickle.load(f)
    with open(dynamic_test_labels_path, "rb") as f:
        dynamic_test_labels = pickle.load(f)

    preds_dynamic = clf_dynamic.predict(dynamic_test_data)

    print(sklearn.metrics.classification_report(dynamic_test_labels, preds_dynamic))


    with open(static_train_malware_path, "rb") as f:
        static_malware_data = pickle.load(f)
    with open(static_train_benign_path, "rb") as f:
        static_benign_data = pickle.load(f)


    static_malware_data = pd.DataFrame(static_malware_data)
    static_benign_data = pd.DataFrame(static_benign_data)
    static_train_labels = np.array([0]*len(static_benign_data) + [1]*len(static_malware_data))
    static_train_data = pd.concat([static_benign_data, static_malware_data], axis=0)

    clf_static = RandomForestClassifier()
    clf_static.fit(static_train_data, static_train_labels)

    with open(static_model_path, "wb") as f:
        pickle.dump(clf_static,f,protocol=pickle.HIGHEST_PROTOCOL)

    with open(static_test_data_path, "rb") as f:
        static_test_data = pickle.load(f)

    with open(static_test_labels_path,"rb") as f:
        static_test_labels = pickle.load(f)

    preds_static = clf_static.predict(static_test_data)

    print(sklearn.metrics.classification_report(static_test_labels, preds_static))


def test(dataset_path):

    files = os.listdir(dataset_path)

    output = dd(lambda: "Benign")
    static_model, dynamic_model = load_models()

    for file in files:
        if os.path.isfile(os.path.join(dataset_path, file)):
            prediction = classify_dynamic(file)
            key = file.split(".")[0]
            if prediction == 0:
                output[key] = "Benign"
            else:
                output[key] = "Malware"
        else:
            prediction = classify_static(file)
            key = file.split(".")[0]
            if prediction == 0:
                output[key] = "Benign"
            else:
                output[key] = "Malware"

    write_csv(output)


if train_index != -1:
    train()
if path_index != -1:
    dataset_path = arguments[path_index]
    test(dataset_path)
